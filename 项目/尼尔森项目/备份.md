
```python 
    max_group_sentences = []
    for group in groups:    # groups 是所有的分组，group 是同一个位置的所有的文字
        # 差异性最大的是字幕
        if len(set(group['sentences'])) > len(set(max_group_sentences)):
            group["is_zimu"] = True
            max_group_sentences = group['sentences']
        else:
            group["is_zimu"] = False

    update_is_zimu(groups)

    # 最后再做一次过滤
    if len(set(max_group_sentences)) <= 5:
        max_group_sentences = []

    all_zimu_sentences = ','.join(max_group_sentences)
    txt.write(all_zimu_sentences)
    txt.close()
```


```python 
def main(video_name):
    frame_dir = settings.VIDEO_FRAME_DIR + video_name.split('.')[0] + '/'
    output_dir = settings.OUTPUT_DIR + video_name.split('.')[0] + '/'
    if not (os.path.exists(output_dir)):
        os.mkdir(output_dir)
    ocr = PaddleOCR(use_angle_cls=True, lang="ch", use_gpu=False)
    run_time = datetime.datetime.now().strftime("%Y_%m_%d_%H_%M_%S")
    txt = open(output_dir + str(run_time) + '.txt', 'a', encoding='utf-8')
    frames = sorted(filter(is_img, os.listdir(frame_dir)))

    groups = grouping_by_position(frames, frame_dir, ocr)

    max_group_sentences = []
    for group in groups:    # groups 是所有的分组，group 是同一个位置的所有的文字
        # 差异性最大的是字幕
        if len(set(group['sentences'])) > len(set(max_group_sentences)):
            group["is_zimu"] = True
            max_group_sentences = group['sentences']
        else:
            group["is_zimu"] = False

    update_is_zimu(groups)

    # 最后再做一次过滤
    if len(set(max_group_sentences)) <= 5:
        max_group_sentences = []

    all_zimu_sentences = ','.join(max_group_sentences)
    txt.write(all_zimu_sentences)
    txt.close()
    get_zimu_position(groups)
    print('finish.')
``` 

```python
def get_ocr_result(frame_dir, img, ocr):
    """一次传入一张图片，OCR 识别这张图片的所有文字，返回结果为[{},{}]格式"""
    image = frame_dir + img
    result = ocr.ocr(image, cls=True)  # OCR 识别。
    print(result)
    ret_result = []
    # line[1][0], line[1][1], line[0]  # 文字   置信度    位置
    for line in result:
        left_upper_y = line[0][0][1]
        left_bottom_y = line[0][3][1]
        ret_result.append({
            'sentence': line[1][0],
            'txt_position': line[0],
            'top': left_upper_y,
            'height': left_bottom_y - left_upper_y
        })
    return ret_result
```  

ocr.py main()  

```python 
   output_dir = settings.OUTPUT_DIR + video_name.split('.')[0] + '/'
   if not (os.path.exists(output_dir)):
       os.mkdir(output_dir)
```

ocr.py grouping_by_position()  
```python 
                # Avoid duplicate: check if current word is similar to last word
                if len(group['sentences']) >= 3:
                    for last_word in group['sentences'][-3:]:
                        if difflib.SequenceMatcher(None, last_word, sentence).quick_ratio() > 0.8:
                            duplicate_flag = True
                            break
                else:
                    last_word = group['sentences'][len(group['sentences']) - 1]
                    if difflib.SequenceMatcher(None, last_word, sentence).quick_ratio() > 0.8:
                        break
                if duplicate_flag:
                    break
```

ocr.py   
```python 
def separate_zimu_huazi(ocr_result, zimu_top, zimu_height):
    """分离字幕和花字，遍历每一句的识别结果，和字幕位置作比较"""
    zimu_list = []
    huazi_list = []
    if zimu_top is None and zimu_height is None:  # 如果没有字幕，则全部文字都是花字
        for line in ocr_result:
            if line['sentence'] not in huazi_list:
                huazi_list.append(line['sentence'])
        return zimu_list, huazi_list
    for line in ocr_result:
        if abs(line["top"] - zimu_top) <= 3 * zimu_height and abs(line["height"] - zimu_height) < 0.15 * zimu_height:
            zimu_list.append(line['sentence'])
        else:
            huazi_list.append(line['sentence'])
    return zimu_list, huazi_list
``` 


