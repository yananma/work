
08.05  

```python
from collections import defaultdict
import pandas as pd

import yaml
import re
from django.conf import settings
from django.core.management import BaseCommand

from data_analysis.connect import ESConnect, ConnectManager
from data_analysis.piplines.es_craw_module import ESSpider

from pathlib import Path


class Command(BaseCommand):
    def add_arguments(self, parser):
        parser.add_argument(
            '-file',
            dest='file',
            default=settings.RESOURCE_ROOT / 'docs' / 'program' / 'ZKY_MAP_SETTING.yaml',
            help='配置的yaml文件',
        )
        parser.add_argument(
            '-si',
            dest='sindex',
            default='test-zky',
            help='查询的索引',
        )

    def handle(self, *args, **options):
        client: ESConnect = ConnectManager.ES.get_setting('DEBUG')
        source_yaml = yaml.load(Path(options['file']).open('r', encoding='utf-8'), Loader=yaml.FullLoader)
        source_data = source_yaml.get('zky_temp_titles', None)
        source_word = source_yaml.get('zky_exclude_words', None)
        print('开始......')
        query_dict = {
            "query": {
                "bool": {
                    "must": [
                        {
                            "bool": {
                                "should": [

                                ]
                            }
                        },
                        {
                            "range": {
                                "post_time": {
                                    "gte": "2021-05-04 00:00:00",
                                    "lt": "2021-08-05 00:00:00"
                                }
                            }
                        }
                    ]
                }
            },
        }
        for data in source_data:
            query_dict["query"]["bool"]['must'][0]['bool']['should'].extend([
                {"term": {
                    "title.keyword": {
                        "value": data
                    }
                }
                }
            ])

        for data, next_search_after in ConnectManager.ES.get_setting('DEFAULT').search_by_page_with_searchafter(
                options['sindex'],
                doc=None,
                fields=['title', 'text', 'url'],
                query=query_dict,
                sort_fields=[{'post_time': 'desc'}, {'include_time': 'desc'}],
                return_sort=True
        ):
            print("开始查询......")
            result_text = [(it['title'], it['text'], it['url']) for it in data]
            print("查询结束......")
            break


        char_translate = str.maketrans({i: '' for i in
                                        r"""!"#$%｜&'()*+,-./:;<=>?@[\]^_`{|}~“”？，！～＠＃％＾＊【】（）、。：；’／
                                        ＼＿－＝☆★○●◎◇◆□€■△▲※→←↑↓¤♂♀〖〗『』」「‖〃‘……￥·"""})
        quchong_result = set()
        l = []
        """
            [
                {  
                    "title":"xxx",
                    "keywords":"TVB,娱乐,吸毒",
                    "url":""
                },
                {  
                    "title":"xxxx",
                    "keywords":"TVB,娱乐,吸毒",
                    "url":""
                },
            ]
        """
        from collections import Counter
        keywords_counter = Counter()
        for text in set(result_text):
            d = {}
            text0 = text[0].translate(char_translate)
            if text0 not in quchong_result:
                quchong_result.add(text[0])
            else:
                continue
            text0 = re.sub(r'(<.*?>)|(\n)', '', text[0])
            text1 = re.sub(r'(<.*?>)', '', text[1])  # 去掉标签和换行

            keywords = []
            for word in source_word:
                if word in text0 + text1:
                    keywords.append(word)
            d["title"] = text[0]
            d['keywords'] = keywords
            d['url'] = text[2]
            l.append(d)
            keywords_counter.update(keywords)
        print()

        dataframe = pd.DataFrame(l)

        dataframe.to_csv(str(settings.RESOURCE_ROOT/'docs'/'program'/'test.csv'), index=False, sep=',')

        print("写入完毕......")
```


